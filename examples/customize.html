<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customize | AccessibleWeb Widget</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <style>
        :root {
            --color-text: #0f172a;
            --color-text-secondary: #334155;
            --color-text-muted: #64748b;
            --color-bg: #f8fafc;
            --color-surface: #f1f5f9;
            --color-border: #dbe4ef;
            --color-accent: #111827;
            --color-panel: #ffffff;
            --color-code-bg: #0b1220;
            --color-code-border: #263146;
            --font-serif: Georgia, "Times New Roman", serif;
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            --page-gutter: clamp(20px, 4vmin, 48px);
            --content-width: 1000px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: var(--font-sans);
            color: var(--color-text);
            background:
                radial-gradient(1200px 560px at 95% -15%, #e6eef7 0%, transparent 62%),
                radial-gradient(900px 460px at -10% 0%, #edf3fa 0%, transparent 62%),
                var(--color-bg);
            -webkit-font-smoothing: antialiased;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px var(--page-gutter);
        }

        .logo {
            font-family: var(--font-serif);
            font-size: clamp(20px, 2vw + 12px, 28px);
            letter-spacing: -0.5px;
            text-decoration: none;
            color: var(--color-text);
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: clamp(12px, 2vw + 4px, 32px);
        }

        .nav-link {
            color: #111;
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .nav-link:hover {
            color: #000;
        }

        .nav-link.is-active {
            text-decoration: underline;
            text-underline-offset: 6px;
            text-decoration-thickness: 2px;
        }

        .nav-link svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
            display: block;
        }

        .btn-primary {
            background: #111;
            color: #fff;
            border: 0;
            border-radius: 9999px;
            font-size: 15px;
            font-weight: 500;
            padding: 12px 24px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary:hover {
            background: #333;
        }

        .btn-secondary {
            background: #fff;
            color: #1e293b;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            line-height: 1;
            padding: 12px 18px;
            cursor: pointer;
            border: 1px solid #cbd5e1;
        }

        .btn-secondary:hover {
            background: #f8fafc;
        }

        .hero {
            max-width: calc(var(--content-width) + var(--page-gutter) * 2);
            margin: 0 auto;
            padding: clamp(24px, 4vw, 48px) var(--page-gutter) clamp(20px, 4vw, 32px);
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
            border-radius: 999px;
            padding: 7px 14px;
            background: rgba(255, 255, 255, 0.92);
        }

        .hero-title {
            margin: 18px 0 14px;
            font-family: var(--font-serif);
            font-size: clamp(2rem, 4vw + 0.5rem, 3.2rem);
            font-weight: 400;
            line-height: 1.08;
            letter-spacing: -0.8px;
        }

        .hero-subtitle {
            margin: 0;
            max-width: 760px;
            color: var(--color-text-secondary);
            font-size: clamp(15px, 1vw + 12px, 19px);
            line-height: 1.7;
        }

        .container {
            max-width: calc(var(--content-width) + var(--page-gutter) * 2);
            margin: 0 auto;
            padding: 0 var(--page-gutter) clamp(40px, 6vw, 72px);
        }

        .builder-layout {
            display: grid;
            grid-template-columns: minmax(300px, 420px) minmax(0, 1fr);
            gap: clamp(16px, 2.2vw, 28px);
            align-items: start;
        }

        .panel {
            background: var(--color-panel);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: clamp(18px, 2.4vw, 28px);
            box-shadow: 0 12px 26px rgba(15, 23, 42, 0.05);
        }

        .panel h2 {
            margin: 0 0 8px;
            font-size: 20px;
        }

        .panel-intro {
            margin: 0 0 18px;
            color: var(--color-text-secondary);
            line-height: 1.65;
            font-size: 14px;
        }

        .control-group + .control-group {
            margin-top: 22px;
            padding-top: 22px;
            border-top: 1px solid #e2e8f0;
        }

        .control-group h3 {
            margin: 0 0 12px;
            font-size: 15px;
            letter-spacing: 0.2px;
            text-transform: uppercase;
            color: var(--color-text-muted);
        }

        .field {
            display: grid;
            gap: 8px;
            margin-bottom: 14px;
        }

        .field-row {
            display: grid;
            grid-template-columns: minmax(0, 1fr) auto;
            gap: 12px;
            align-items: end;
        }

        .field label {
            font-size: 14px;
            font-weight: 600;
        }

        .field input,
        .field select {
            width: 100%;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            background: #fff;
            color: #0f172a;
            font-size: 14px;
            padding: 10px 12px;
            font-family: var(--font-sans);
        }

        .field.color-field {
            margin-bottom: 14px;
        }

        .field.color-field input[type="color"] {
            width: 46px;
            height: 46px;
            min-height: 46px;
            padding: 0;
            border-radius: 999px;
            border: 2px solid #cbd5e1;
            background: transparent;
            appearance: none;
            cursor: pointer;
        }

        .field.color-field input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .field.color-field input[type="color"]::-webkit-color-swatch {
            border: 0;
            border-radius: 999px;
        }

        .field.color-field input[type="color"]::-moz-color-swatch {
            border: 0;
            border-radius: 999px;
        }

        .field input:focus,
        .field select:focus {
            outline: 3px solid rgba(59, 130, 246, 0.24);
            border-color: #60a5fa;
        }

        .range-row {
            display: grid;
            grid-template-columns: minmax(0, 1fr) auto;
            gap: 10px;
            align-items: center;
        }

        .range-row input[type="range"] {
            padding: 0;
            border: 0;
            background: transparent;
        }

        .range-value {
            min-width: 54px;
            font-family: var(--font-mono);
            font-size: 12px;
            text-align: center;
            color: #0f172a;
            border: 1px solid #d5deea;
            border-radius: 999px;
            background: #f8fafc;
            padding: 4px 8px;
        }

        .form-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 6px;
        }

        .preview-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .preview-panel-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .preview-note {
            margin: 0 0 14px;
            color: var(--color-text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }

        .preview-frame {
            width: 100%;
            height: min(68vh, 720px);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            background: #fff;
        }

        .export-section {
            margin-top: clamp(20px, 3.5vw, 34px);
        }

        .export-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .export-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .export-note {
            margin: 0;
            color: var(--color-text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }

        .export-code {
            margin: 0;
            border: 1px solid var(--color-code-border);
            border-radius: 12px;
            background: var(--color-code-bg);
            color: #e2e8f0;
            padding: 16px;
            overflow: auto;
            max-height: 420px;
        }

        .export-code code {
            font-family: var(--font-mono);
            font-size: 12px;
            line-height: 1.6;
            white-space: pre;
        }

        .status {
            margin-top: 10px;
            color: #166534;
            font-size: 13px;
            min-height: 1em;
        }

        .voice-status {
            color: var(--color-text-muted);
            font-size: 12px;
            line-height: 1.5;
            min-height: 1.5em;
        }

        .footer {
            border-top: 1px solid var(--color-border);
            margin-top: 24px;
            padding: 28px var(--page-gutter);
            display: flex;
            justify-content: space-between;
            gap: 16px;
            max-width: calc(var(--content-width) + var(--page-gutter) * 2);
            margin-left: auto;
            margin-right: auto;
        }

        .footer-left {
            font-size: 14px;
            color: var(--color-text-muted);
        }

        .footer-links {
            display: flex;
            gap: 20px;
        }

        .footer-links a {
            font-size: 14px;
            color: var(--color-text-muted);
            text-decoration: none;
        }

        .footer-links a:hover {
            color: var(--color-text);
        }

        @media (max-width: 980px) {
            .builder-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            .nav-link:not([aria-label]) {
                display: none;
            }

            .btn-primary {
                padding: 10px 20px;
                font-size: 14px;
            }

            .preview-panel-header,
            .export-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .field-row {
                grid-template-columns: 1fr;
            }

            .footer {
                flex-direction: column;
                text-align: center;
            }

            .footer-links {
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <a href="./index.html" class="logo">AccessibleWeb</a>
        <div class="nav-links">
            <a href="https://github.com/ifrederico/accessible-web-widget" target="_blank" rel="noopener"
                class="nav-link" aria-label="GitHub">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" />
                </svg>
            </a>
            <a href="./index.html#features" class="nav-link">Features</a>
            <a href="./customize.html" class="nav-link is-active">Customize</a>
            <a href="./index.html#implementation" class="btn-primary">Get Widget</a>
        </div>
    </nav>

    <header class="hero">
        <div class="hero-badge">Code Generator</div>
        <h1 class="hero-title">Build your widget config and export ready-to-paste code.</h1>
        <p class="hero-subtitle">Choose position, offset, size, accent color, and text-to-speech voice settings. Changes
            update live in preview, so you can test interactions before copying the generated snippet.</p>
    </header>

    <main class="container">
        <div class="builder-layout">
            <section class="panel" aria-labelledby="config-heading">
                <h2 id="config-heading">Customize Settings</h2>
                <p class="panel-intro">Adjust values to update preview instantly. Exported code always mirrors your current
                    selections.</p>

                <form id="config-form" novalidate>
                    <div class="control-group">
                        <h3>Widget Layout</h3>

                        <div class="field-row">
                            <div class="field">
                                <label for="position">Position</label>
                                <select id="position" name="position">
                                    <option value="bottom-right">Bottom Right</option>
                                    <option value="bottom-left">Bottom Left</option>
                                    <option value="top-right">Top Right</option>
                                    <option value="top-left">Top Left</option>
                                    <option value="center-left">Center Left</option>
                                </select>
                            </div>

                            <div class="field color-field">
                                <label for="accentColor">Accent Color</label>
                                <input id="accentColor" name="accentColor" type="color" value="#1976d2">
                            </div>
                        </div>

                        <div class="field">
                            <label for="offsetX">Offset X</label>
                            <div class="range-row">
                                <input id="offsetX" name="offsetX" type="range" min="0" max="120" step="1" value="24">
                                <output class="range-value" id="offsetX-value" for="offsetX">24px</output>
                            </div>
                        </div>

                        <div class="field">
                            <label for="offsetY">Offset Y</label>
                            <div class="range-row">
                                <input id="offsetY" name="offsetY" type="range" min="0" max="120" step="1" value="24">
                                <output class="range-value" id="offsetY-value" for="offsetY">24px</output>
                            </div>
                        </div>

                        <div class="field">
                            <label for="size">Button Size</label>
                            <div class="range-row">
                                <input id="size" name="size" type="range" min="24" max="96" step="1" value="52">
                                <output class="range-value" id="size-value" for="size">52px</output>
                            </div>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Voice Settings</h3>

                        <div class="field">
                            <label for="ttsNativeVoiceName">Voice Name</label>
                            <select id="ttsNativeVoiceName" name="ttsNativeVoiceName">
                                <option value="">Default browser voice</option>
                            </select>
                        </div>

                        <div class="field">
                            <label for="ttsRate">Rate</label>
                            <div class="range-row">
                                <input id="ttsRate" name="ttsRate" type="range" min="0.5" max="2" step="0.1" value="1">
                                <output class="range-value" id="ttsRate-value" for="ttsRate">1.0</output>
                            </div>
                        </div>

                        <div class="field">
                            <label for="ttsPitch">Pitch</label>
                            <div class="range-row">
                                <input id="ttsPitch" name="ttsPitch" type="range" min="0" max="2" step="0.1" value="1">
                                <output class="range-value" id="ttsPitch-value" for="ttsPitch">1.0</output>
                            </div>
                        </div>

                        <div class="field">
                            <button type="button" class="btn-secondary" id="test-voice" aria-pressed="false">Play Voice Sample</button>
                            <div class="voice-status" id="voice-status" aria-live="polite"></div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="reset-defaults">Reset Defaults</button>
                    </div>
                </form>
            </section>

            <section class="panel" aria-labelledby="preview-heading">
                <div class="preview-panel-header">
                    <h2 id="preview-heading">Live Preview</h2>
                </div>
                <p class="preview-note">Use the floating widget inside this isolated preview to test behavior before exporting code.</p>
                <iframe id="widget-preview" class="preview-frame" title="AccessibleWeb Widget preview"
                    sandbox="allow-scripts allow-same-origin"></iframe>
            </section>
        </div>

        <section class="panel export-section" aria-labelledby="export-heading">
            <div class="export-header">
                <h2 id="export-heading">Export Code</h2>
                <button type="button" class="btn-secondary" id="copy-export">Copy Code</button>
            </div>
            <p class="export-note">Paste this snippet into your site before <code>&lt;/body&gt;</code>.</p>
            <pre class="export-code"><code id="export-code"></code></pre>
            <div class="status" id="copy-status" aria-live="polite"></div>
        </section>
    </main>

    <footer class="footer">
        <div class="footer-left">AccessibleWeb Widget &middot; MIT License</div>
        <div class="footer-links">
            <a href="https://github.com/ifrederico/accessible-web-widget" target="_blank" rel="noopener">GitHub</a>
            <a href="https://github.com/ifrederico/accessible-web-widget/blob/main/DISCLAIMER.md" target="_blank"
                rel="noopener">Disclaimer</a>
        </div>
    </footer>

    <script>
        (function () {
            var defaults = {
                position: 'top-right',
                offsetX: 24,
                offsetY: 24,
                size: 52,
                accentColor: '#1976d2',
                ttsNativeVoiceName: 'Samantha',
                ttsRate: 1.0,
                ttsPitch: 1.0
            };

            var samplePoem = "There was an Old Man with a beard, who said, \"It is just as I feared! Two owls and a hen, four larks and a wren, have all built their nests in my beard!\"";

            var layoutFieldNames = {
                position: true,
                offsetX: true,
                offsetY: true,
                size: true
            };

            var form = document.getElementById('config-form');
            var previewFrame = document.getElementById('widget-preview');
            var exportCode = document.getElementById('export-code');
            var copyButton = document.getElementById('copy-export');
            var copyStatus = document.getElementById('copy-status');
            var resetButton = document.getElementById('reset-defaults');
            var testVoiceButton = document.getElementById('test-voice');
            var voiceStatus = document.getElementById('voice-status');
            var localBundleUrl = new URL('../dist/accessible-web-widget.js', window.location.href).href;
            var availableVoices = [];
            var isVoiceSamplePlaying = false;
            var activeVoiceUtterance = null;

            var rangeOutputs = {
                offsetX: document.getElementById('offsetX-value'),
                offsetY: document.getElementById('offsetY-value'),
                size: document.getElementById('size-value'),
                ttsRate: document.getElementById('ttsRate-value'),
                ttsPitch: document.getElementById('ttsPitch-value')
            };

            function setSelectOptions(select, options) {
                while (select.firstChild) {
                    select.removeChild(select.firstChild);
                }
                options.forEach(function (optionData) {
                    var option = document.createElement('option');
                    option.value = optionData.value;
                    option.textContent = optionData.label;
                    select.appendChild(option);
                });
            }

            function hasOptionValue(select, value) {
                return Array.prototype.some.call(select.options, function (option) {
                    return option.value === value;
                });
            }

            function sortVoices(a, b) {
                if (a.default && !b.default) return -1;
                if (!a.default && b.default) return 1;
                return String(a.name || '').localeCompare(String(b.name || ''));
            }

            function findVoiceByName(name) {
                if (!name) return null;
                return availableVoices.find(function (voice) {
                    return String(voice.name || '') === name;
                }) || null;
            }

            function updateVoiceButtonState() {
                testVoiceButton.textContent = isVoiceSamplePlaying ? 'Stop Voice Sample' : 'Play Voice Sample';
                testVoiceButton.setAttribute('aria-pressed', isVoiceSamplePlaying ? 'true' : 'false');
            }

            function stopVoiceSample(showMessage) {
                if (!window.speechSynthesis || typeof window.speechSynthesis.cancel !== 'function') return;
                activeVoiceUtterance = null;
                isVoiceSamplePlaying = false;
                window.speechSynthesis.cancel();
                updateVoiceButtonState();
                if (showMessage) {
                    voiceStatus.textContent = 'Voice test stopped.';
                }
            }

            function loadAvailableVoices(preserveSelection) {
                var keepSelection = preserveSelection !== false;
                var voiceNameSelect = form.elements.ttsNativeVoiceName;
                var previousName = keepSelection ? String(voiceNameSelect.value || defaults.ttsNativeVoiceName) : '';

                if (!window.speechSynthesis || typeof window.speechSynthesis.getVoices !== 'function') {
                    availableVoices = [];
                    setSelectOptions(voiceNameSelect, [{ value: '', label: 'Speech synthesis not supported' }]);
                    voiceNameSelect.disabled = true;
                    testVoiceButton.disabled = true;
                    isVoiceSamplePlaying = false;
                    activeVoiceUtterance = null;
                    updateVoiceButtonState();
                    voiceStatus.textContent = 'This browser does not expose speech synthesis voices.';
                    return;
                }

                var voices = window.speechSynthesis.getVoices().slice().sort(sortVoices);
                availableVoices = voices;

                var voiceOptions = [{ value: '', label: 'Default browser voice' }];
                voices.forEach(function (voice) {
                    var label = String(voice.name || 'Unnamed voice');
                    if (voice.lang) label += ' (' + voice.lang + ')';
                    if (voice.default) label += ' [default]';
                    voiceOptions.push({ value: String(voice.name || ''), label: label });
                });
                setSelectOptions(voiceNameSelect, voiceOptions);

                voiceNameSelect.disabled = false;
                testVoiceButton.disabled = false;
                updateVoiceButtonState();

                if (previousName && hasOptionValue(voiceNameSelect, previousName)) {
                    voiceNameSelect.value = previousName;
                } else if (hasOptionValue(voiceNameSelect, defaults.ttsNativeVoiceName)) {
                    voiceNameSelect.value = defaults.ttsNativeVoiceName;
                } else {
                    voiceNameSelect.value = '';
                }

                if (voices.length) {
                    voiceStatus.textContent = 'Found ' + voices.length + ' browser voice(s).';
                } else {
                    voiceStatus.textContent = 'No voices reported yet. Click the test button after interacting with the page.';
                }
            }

            function speakVoiceSample() {
                if (!window.speechSynthesis || typeof window.SpeechSynthesisUtterance !== 'function') {
                    voiceStatus.textContent = 'Speech synthesis is not available in this browser.';
                    return;
                }

                var config = getConfig();
                var utterance = new SpeechSynthesisUtterance(samplePoem);
                var selectedVoice = findVoiceByName(config.ttsNativeVoiceName);
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                    if (selectedVoice.lang) {
                        utterance.lang = selectedVoice.lang;
                    }
                }
                utterance.rate = config.ttsRate;
                utterance.pitch = config.ttsPitch;
                utterance.onstart = function () {
                    if (activeVoiceUtterance !== utterance) return;
                    voiceStatus.textContent = 'Reading a famous limerick...';
                };
                utterance.onend = function () {
                    if (activeVoiceUtterance !== utterance) return;
                    activeVoiceUtterance = null;
                    isVoiceSamplePlaying = false;
                    updateVoiceButtonState();
                    voiceStatus.textContent = 'Voice test finished.';
                };
                utterance.onerror = function () {
                    if (activeVoiceUtterance !== utterance) return;
                    activeVoiceUtterance = null;
                    isVoiceSamplePlaying = false;
                    updateVoiceButtonState();
                    voiceStatus.textContent = 'Could not play voice test.';
                };
                stopVoiceSample(false);
                activeVoiceUtterance = utterance;
                isVoiceSamplePlaying = true;
                updateVoiceButtonState();
                window.speechSynthesis.speak(utterance);
            }

            function toggleVoiceSample() {
                if (isVoiceSamplePlaying) {
                    stopVoiceSample(true);
                    return;
                }
                speakVoiceSample();
            }

            function clamp(number, min, max) {
                return Math.min(max, Math.max(min, number));
            }

            function toNumber(value, fallback) {
                var parsed = Number(value);
                return Number.isFinite(parsed) ? parsed : fallback;
            }

            function formatDecimal(value) {
                return Number(value).toFixed(1);
            }

            function quoteJs(value) {
                return JSON.stringify(String(value || ''));
            }

            function escapeHtmlAttr(value) {
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            }

            function normalizeHexColor(value, fallback) {
                var input = String(value || '').trim();
                if (/^#[0-9a-fA-F]{3}$/.test(input)) {
                    var r = input.charAt(1);
                    var g = input.charAt(2);
                    var b = input.charAt(3);
                    return ('#' + r + r + g + g + b + b).toLowerCase();
                }
                if (/^#[0-9a-fA-F]{6}$/.test(input)) {
                    return input.toLowerCase();
                }
                return String(fallback || defaults.accentColor).toLowerCase();
            }

            function hexToRgb(hex) {
                var normalized = normalizeHexColor(hex, defaults.accentColor);
                return {
                    r: parseInt(normalized.slice(1, 3), 16),
                    g: parseInt(normalized.slice(3, 5), 16),
                    b: parseInt(normalized.slice(5, 7), 16)
                };
            }

            function rgbToHex(rgb) {
                var r = Math.min(255, Math.max(0, Math.round(rgb.r)));
                var g = Math.min(255, Math.max(0, Math.round(rgb.g)));
                var b = Math.min(255, Math.max(0, Math.round(rgb.b)));
                return '#' + [r, g, b].map(function (channel) {
                    return channel.toString(16).padStart(2, '0');
                }).join('');
            }

            function mixHexColor(baseHex, targetRgb, weight) {
                var base = hexToRgb(baseHex);
                var clampedWeight = Math.min(1, Math.max(0, Number(weight)));
                return rgbToHex({
                    r: base.r + (targetRgb.r - base.r) * clampedWeight,
                    g: base.g + (targetRgb.g - base.g) * clampedWeight,
                    b: base.b + (targetRgb.b - base.b) * clampedWeight
                });
            }

            function deriveAccentColors(accentHex) {
                var base = normalizeHexColor(accentHex, defaults.accentColor);
                return {
                    base: base,
                    light: mixHexColor(base, { r: 255, g: 255, b: 255 }, 0.22),
                    dark: mixHexColor(base, { r: 0, g: 0, b: 0 }, 0.28)
                };
            }

            function buildThemeOptions(accentHex) {
                var colors = deriveAccentColors(accentHex);
                return {
                    primaryColor: colors.base,
                    primaryColorLight: colors.light,
                    primaryColorDark: colors.dark,
                    focusRingColor: colors.base,
                    hoverColor: colors.light,
                    activeColor: colors.dark
                };
            }

            function getConfig() {
                var position = String(form.elements.position.value || defaults.position);
                var offsetX = Math.round(clamp(toNumber(form.elements.offsetX.value, defaults.offsetX), 0, 120));
                var offsetY = Math.round(clamp(toNumber(form.elements.offsetY.value, defaults.offsetY), 0, 120));
                var size = Math.round(clamp(toNumber(form.elements.size.value, defaults.size), 24, 96));
                var accentColor = normalizeHexColor(form.elements.accentColor.value, defaults.accentColor);
                var voiceName = String(form.elements.ttsNativeVoiceName.value || '').trim();
                var rate = clamp(toNumber(form.elements.ttsRate.value, defaults.ttsRate), 0.5, 2);
                var pitch = clamp(toNumber(form.elements.ttsPitch.value, defaults.ttsPitch), 0, 2);

                return {
                    position: position,
                    offsetX: offsetX,
                    offsetY: offsetY,
                    size: size,
                    accentColor: accentColor,
                    ttsNativeVoiceName: voiceName,
                    ttsRate: Number(formatDecimal(rate)),
                    ttsPitch: Number(formatDecimal(pitch))
                };
            }

            function updateRangeValues(config) {
                rangeOutputs.offsetX.textContent = config.offsetX + 'px';
                rangeOutputs.offsetY.textContent = config.offsetY + 'px';
                rangeOutputs.size.textContent = config.size + 'px';
                rangeOutputs.ttsRate.textContent = formatDecimal(config.ttsRate);
                rangeOutputs.ttsPitch.textContent = formatDecimal(config.ttsPitch);
            }

            function buildExportSnippet(config) {
                var themeOptions = buildThemeOptions(config.accentColor);
                return [
                    '<!-- AccessibleWeb Widget -->',
                    '<div data-acc-position="' + escapeHtmlAttr(config.position) + '"></div>',
                    '<div data-acc-offset="' + config.offsetX + ',' + config.offsetY + '"></div>',
                    '<div data-acc-size="' + config.size + '"></div>',
                    '<script>',
                    '  window.AccessibleWebWidgetOptions = {',
                    '    primaryColor: ' + quoteJs(themeOptions.primaryColor) + ',',
                    '    primaryColorLight: ' + quoteJs(themeOptions.primaryColorLight) + ',',
                    '    primaryColorDark: ' + quoteJs(themeOptions.primaryColorDark) + ',',
                    '    focusRingColor: ' + quoteJs(themeOptions.focusRingColor) + ',',
                    '    hoverColor: ' + quoteJs(themeOptions.hoverColor) + ',',
                    '    activeColor: ' + quoteJs(themeOptions.activeColor) + ',',
                    '    ttsNativeVoiceName: ' + quoteJs(config.ttsNativeVoiceName) + ',',
                    '    ttsRate: ' + formatDecimal(config.ttsRate) + ',',
                    '    ttsPitch: ' + formatDecimal(config.ttsPitch) + ',',
                    '    ...(window.AccessibleWebWidgetOptions || {})',
                    '  };',
                    '<\/script>',
                    '<script src="https://cdn.jsdelivr.net/gh/ifrederico/accessible-web-widget@latest/dist/accessible-web-widget.min.js"><\/script>'
                ].join('\n');
            }

            function buildPreviewDocument(config) {
                var themeOptions = buildThemeOptions(config.accentColor);
                return '<!DOCTYPE html>\n' +
                    '<html lang="en">\n' +
                    '<head>\n' +
                    '  <meta charset="UTF-8">\n' +
                    '  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
                    '  <title>AccessibleWeb Preview</title>\n' +
                    '  <style>\n' +
                    '    :root { color-scheme: light; }\n' +
                    '    body { margin: 0; background: var(--acc-card-bg, #ffffff); }\n' +
                    '    .preview-wrap { padding: 26px; }\n' +
                    '    .sk { border-radius: 10px; background: #d9dde3; }\n' +
                    '    .sk-row { display: flex; gap: 12px; align-items: center; margin-bottom: 20px; }\n' +
                    '    .sk-logo { width: 130px; height: 20px; border-radius: 999px; }\n' +
                    '    .sk-chip { width: 72px; height: 16px; border-radius: 999px; }\n' +
                    '    .sk-chip.wide { width: 118px; }\n' +
                    '    .sk-hero-title { width: 72%; max-width: 540px; height: 36px; margin-bottom: 14px; }\n' +
                    '    .sk-hero-line { height: 14px; margin-bottom: 10px; }\n' +
                    '    .sk-hero-line.short { width: 76%; }\n' +
                    '    .sk-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px; margin-top: 18px; }\n' +
                    '    .sk-card { border-radius: 12px; padding: 14px; background: #eef2f7; }\n' +
                    '    .sk-card-title { width: 45%; height: 16px; margin-bottom: 12px; }\n' +
                    '    .sk-card-line { height: 11px; margin-bottom: 8px; }\n' +
                    '    .sk-card-line:last-child { margin-bottom: 0; width: 82%; }\n' +
                    '    .sk-band { height: 42px; border-radius: 12px; margin-top: 16px; }\n' +
                    '    .sk-band.thin { height: 24px; margin-top: 12px; width: 64%; }\n' +
                    '    @media (max-width: 700px) { .preview-wrap { padding: 18px; } .sk-grid { grid-template-columns: 1fr; } .sk-hero-title { width: 92%; } }\n' +
                    '  </style>\n' +
                    '</head>\n' +
                    '<body>\n' +
                    '  <main class="preview-wrap">\n' +
                    '    <div class="sk-row">\n' +
                    '      <div class="sk sk-logo"></div>\n' +
                    '      <div class="sk sk-chip"></div>\n' +
                    '      <div class="sk sk-chip"></div>\n' +
                    '      <div class="sk sk-chip wide"></div>\n' +
                    '    </div>\n' +
                    '    <div class="sk sk-hero-title"></div>\n' +
                    '    <div class="sk sk-hero-line"></div>\n' +
                    '    <div class="sk sk-hero-line short"></div>\n' +
                    '    <div class="sk-grid">\n' +
                    '      <article class="sk-card">\n' +
                    '        <div class="sk sk-card-title"></div>\n' +
                    '        <div class="sk sk-card-line"></div>\n' +
                    '        <div class="sk sk-card-line"></div>\n' +
                    '        <div class="sk sk-card-line"></div>\n' +
                    '      </article>\n' +
                    '      <article class="sk-card">\n' +
                    '        <div class="sk sk-card-title"></div>\n' +
                    '        <div class="sk sk-card-line"></div>\n' +
                    '        <div class="sk sk-card-line"></div>\n' +
                    '        <div class="sk sk-card-line"></div>\n' +
                    '      </article>\n' +
                    '    </div>\n' +
                    '    <div class="sk sk-band"></div>\n' +
                    '    <div class="sk sk-band thin"></div>\n' +
                    '  </main>\n' +
                    '  <div data-acc-position="' + escapeHtmlAttr(config.position) + '"></div>\n' +
                    '  <div data-acc-offset="' + config.offsetX + ',' + config.offsetY + '"></div>\n' +
                    '  <div data-acc-size="' + config.size + '"></div>\n' +
                    '  <script>\n' +
                    '    window.AccessibleWebWidgetOptions = {\n' +
                    '      primaryColor: ' + quoteJs(themeOptions.primaryColor) + ',\n' +
                    '      primaryColorLight: ' + quoteJs(themeOptions.primaryColorLight) + ',\n' +
                    '      primaryColorDark: ' + quoteJs(themeOptions.primaryColorDark) + ',\n' +
                    '      focusRingColor: ' + quoteJs(themeOptions.focusRingColor) + ',\n' +
                    '      hoverColor: ' + quoteJs(themeOptions.hoverColor) + ',\n' +
                    '      activeColor: ' + quoteJs(themeOptions.activeColor) + ',\n' +
                    '      ttsNativeVoiceName: ' + quoteJs(config.ttsNativeVoiceName) + ',\n' +
                    '      ttsRate: ' + formatDecimal(config.ttsRate) + ',\n' +
                    '      ttsPitch: ' + formatDecimal(config.ttsPitch) + ',\n' +
                    '      ...(window.AccessibleWebWidgetOptions || {})\n' +
                    '    };\n' +
                    '  <\/script>\n' +
                    '  <script src="' + escapeHtmlAttr(localBundleUrl) + '"><\/script>\n' +
                    '</body>\n' +
                    '</html>';
            }

            function applyLayoutToPreview(config) {
                var frameWindow = previewFrame.contentWindow;
                if (!frameWindow || !frameWindow.document) return false;
                var btn = frameWindow.document.querySelector('.acc-widget .acc-toggle-btn');
                if (!btn) return false;

                btn.style.left = 'auto';
                btn.style.right = 'auto';
                btn.style.top = 'auto';
                btn.style.bottom = 'auto';
                btn.style.transform = '';

                if (config.position === 'bottom-right') {
                    btn.style.right = config.offsetX + 'px';
                    btn.style.bottom = config.offsetY + 'px';
                } else if (config.position === 'top-left') {
                    btn.style.left = config.offsetX + 'px';
                    btn.style.top = config.offsetY + 'px';
                } else if (config.position === 'top-right') {
                    btn.style.right = config.offsetX + 'px';
                    btn.style.top = config.offsetY + 'px';
                } else if (config.position === 'center-left') {
                    btn.style.left = config.offsetX + 'px';
                    btn.style.top = '50%';
                    btn.style.transform = 'translateY(-50%)';
                } else {
                    btn.style.left = config.offsetX + 'px';
                    btn.style.bottom = config.offsetY + 'px';
                }

                btn.style.setProperty('--acc-button-size', config.size + 'px');
                return true;
            }

            function applyColorToPreview(config) {
                var frameWindow = previewFrame.contentWindow;
                if (!frameWindow || !frameWindow.document || !frameWindow.document.documentElement) return false;
                var themeOptions = buildThemeOptions(config.accentColor);
                var root = frameWindow.document.documentElement;
                root.style.setProperty('--acc-primary-color', themeOptions.primaryColor);
                root.style.setProperty('--acc-primary-color-light', themeOptions.primaryColorLight);
                root.style.setProperty('--acc-primary-color-dark', themeOptions.primaryColorDark);
                root.style.setProperty('--acc-focus-ring-color', themeOptions.focusRingColor);
                root.style.setProperty('--acc-hover-color', themeOptions.hoverColor);
                root.style.setProperty('--acc-active-color', themeOptions.activeColor);
                return true;
            }

            function applyPreviewFromConfig(config) {
                previewFrame.srcdoc = buildPreviewDocument(config);
            }

            function refreshExport() {
                var config = getConfig();
                updateRangeValues(config);
                exportCode.textContent = buildExportSnippet(config);
            }

            function applyPreview() {
                var config = getConfig();
                updateRangeValues(config);
                exportCode.textContent = buildExportSnippet(config);
                applyPreviewFromConfig(config);
                copyStatus.textContent = '';
            }

            function handleControlUpdate(fieldName) {
                var config = getConfig();
                updateRangeValues(config);
                exportCode.textContent = buildExportSnippet(config);
                copyStatus.textContent = '';

                if (layoutFieldNames[fieldName]) {
                    if (!applyLayoutToPreview(config)) {
                        applyPreviewFromConfig(config);
                    }
                    return;
                }

                if (fieldName === 'accentColor') {
                    if (!applyColorToPreview(config)) {
                        applyPreviewFromConfig(config);
                    }
                    return;
                }

                applyPreviewFromConfig(config);
            }

            function setFormValues(config) {
                form.elements.position.value = config.position;
                form.elements.offsetX.value = String(config.offsetX);
                form.elements.offsetY.value = String(config.offsetY);
                form.elements.size.value = String(config.size);
                form.elements.accentColor.value = normalizeHexColor(config.accentColor, defaults.accentColor);
                if (hasOptionValue(form.elements.ttsNativeVoiceName, config.ttsNativeVoiceName)) {
                    form.elements.ttsNativeVoiceName.value = config.ttsNativeVoiceName;
                } else {
                    form.elements.ttsNativeVoiceName.value = '';
                }
                form.elements.ttsRate.value = formatDecimal(config.ttsRate);
                form.elements.ttsPitch.value = formatDecimal(config.ttsPitch);
            }

            if (window.speechSynthesis && typeof window.speechSynthesis.addEventListener === 'function') {
                window.speechSynthesis.addEventListener('voiceschanged', function () {
                    loadAvailableVoices(true);
                    refreshExport();
                });
            } else if (window.speechSynthesis) {
                window.speechSynthesis.onvoiceschanged = function () {
                    loadAvailableVoices(true);
                    refreshExport();
                };
            }

            testVoiceButton.addEventListener('click', function () {
                toggleVoiceSample();
            });

            form.addEventListener('input', function (event) {
                var fieldName = event.target && event.target.name ? event.target.name : '';
                handleControlUpdate(fieldName);
            });

            form.addEventListener('change', function (event) {
                var fieldName = event.target && event.target.name ? event.target.name : '';
                handleControlUpdate(fieldName);
            });

            resetButton.addEventListener('click', function () {
                setFormValues(defaults);
                applyPreview();
            });

            copyButton.addEventListener('click', function () {
                var text = exportCode.textContent;
                if (!navigator.clipboard || !navigator.clipboard.writeText) {
                    copyStatus.textContent = 'Clipboard unavailable in this browser.';
                    return;
                }
                navigator.clipboard.writeText(text).then(function () {
                    copyStatus.textContent = 'Code copied.';
                }).catch(function () {
                    copyStatus.textContent = 'Could not copy. Select and copy manually.';
                });
            });

            loadAvailableVoices(false);
            updateVoiceButtonState();
            setFormValues(defaults);
            applyPreview();
        })();
    </script>
</body>

</html>
