<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customize | AccessibleWeb Widget</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <link rel="stylesheet" href="./styles.css">
</head>

<body class="customize-page">
    <nav class="navbar">
        <a href="./index.html" class="logo">AccessibleWeb</a>
        <button type="button" class="nav-toggle" aria-label="Toggle navigation menu" aria-expanded="false">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="nav-links">
            <a href="./customize.html" class="nav-link is-active">Customize</a>
            <a href="./faq.html" class="nav-link">FAQ</a>
            <a href="./audit.html" class="nav-link">Audit</a>
            <a href="./get-widget.html" class="btn-primary">Get Widget</a>
        </div>
    </nav>

    <header class="hero">
        <h1 class="hero-title">Build your widget config and export ready-to-paste code.</h1>
        <p class="hero-subtitle">Choose position, offset, size, accent color, and text-to-speech voice settings. Changes
            update live in preview, so you can test interactions before copying the generated snippet.</p>
    </header>

    <main class="container">
        <div class="builder-layout">
            <section class="panel" aria-labelledby="config-heading">
                <h2 id="config-heading">Customize Settings</h2>
                <p class="panel-intro">Adjust values to update preview instantly. Exported code always mirrors your current
                    selections.</p>

                <form id="config-form" novalidate>
                    <div class="control-group">
                        <h3>Widget Layout</h3>

                        <div class="field-row">
                            <div class="field">
                                <label for="position">Position</label>
                                <select id="position" name="position">
                                    <option value="bottom-right">Bottom Right</option>
                                    <option value="bottom-left">Bottom Left</option>
                                    <option value="top-right">Top Right</option>
                                    <option value="top-left">Top Left</option>
                                </select>
                            </div>

                            <div class="field color-field">
                                <label for="accentColor">Accent Color</label>
                                <input id="accentColor" name="accentColor" type="color" value="#1976d2">
                            </div>
                        </div>

                        <div class="field">
                            <label>Widget Icon</label>
                            <div class="icon-picker" role="radiogroup" aria-label="Widget Icon">
                                <label class="icon-picker-option">
                                    <input type="radio" name="icon" value="default" aria-label="Default icon" checked>
                                    <span class="icon-picker-preview" aria-hidden="true">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M423.5-743.5Q400-767 400-800t23.5-56.5Q447-880 480-880t56.5 23.5Q560-833 560-800t-23.5 56.5Q513-720 480-720t-56.5-23.5ZM360-80v-520q-60-5-122-15t-118-25l20-80q78 21 166 30.5t174 9.5q86 0 174-9.5T820-720l20 80q-56 15-118 25t-122 15v520h-80v-240h-80v240h-80Z"/></svg>
                                    </span>
                                </label>
                                <label class="icon-picker-option">
                                    <input type="radio" name="icon" value="icon-2" aria-label="Icon option 2">
                                    <span class="icon-picker-preview" aria-hidden="true">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M423.5-743.5Q400-767 400-800t23.5-56.5Q447-880 480-880t56.5 23.5Q560-833 560-800t-23.5 56.5Q513-720 480-720t-56.5-23.5ZM360-80v-520H120v-80h720v80H600v520h-80v-240h-80v240h-80Z"/></svg>
                                    </span>
                                </label>
                                <label class="icon-picker-option">
                                    <input type="radio" name="icon" value="icon-3" aria-label="Icon option 3">
                                    <span class="icon-picker-preview" aria-hidden="true">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M423.5-743.5Q400-767 400-800t23.5-56.5Q447-880 480-880t56.5 23.5Q560-833 560-800t-23.5 56.5Q513-720 480-720t-56.5-23.5ZM680-80v-200H480q-33 0-56.5-23.5T400-360v-240q0-33 23.5-56.5T480-680q24 0 41.5 10.5T559-636q55 66 99.5 90.5T760-520v80q-53 0-107-23t-93-55v138h120q33 0 56.5 23.5T760-300v220h-80Zm-280 0q-83 0-141.5-58.5T200-280q0-72 45.5-127T360-476v82q-35 14-57.5 44.5T280-280q0 50 35 85t85 35q39 0 69.5-22.5T514-240h82q-14 69-69 114.5T400-80Z"/></svg>
                                    </span>
                                </label>
                                <label class="icon-picker-option">
                                    <input type="radio" name="icon" value="icon-4" aria-label="Icon option 4">
                                    <span class="icon-picker-preview" aria-hidden="true">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M320-80q-83 0-141.5-58.5T120-280q0-83 58.5-141.5T320-480v80q-50 0-85 35t-35 85q0 50 35 85t85 35q50 0 85-35t35-85h80q0 83-58.5 141.5T320-80Zm360-40v-200H440q-44 0-68-37.5t-6-78.5l74-164h-91l-24 62-77-22 28-72q9-23 29.5-35.5T350-680h208q45 0 68.5 36.5T632-566l-66 146h114q33 0 56.5 23.5T760-340v220h-80Zm-96.5-603.5Q560-747 560-780t23.5-56.5Q607-860 640-860t56.5 23.5Q720-813 720-780t-23.5 56.5Q673-700 640-700t-56.5-23.5Z"/></svg>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <div class="field">
                            <label for="offsetX">Offset X</label>
                            <div class="range-row">
                                <input id="offsetX" name="offsetX" type="range" min="0" max="120" step="1" value="24">
                                <output class="range-value" id="offsetX-value" for="offsetX">24px</output>
                            </div>
                        </div>

                        <div class="field">
                            <label for="offsetY">Offset Y</label>
                            <div class="range-row">
                                <input id="offsetY" name="offsetY" type="range" min="0" max="120" step="1" value="24">
                                <output class="range-value" id="offsetY-value" for="offsetY">24px</output>
                            </div>
                        </div>

                        <div class="field">
                            <label for="size">Button Size</label>
                            <div class="range-row">
                                <input id="size" name="size" type="range" min="24" max="96" step="1" value="52">
                                <output class="range-value" id="size-value" for="size">52px</output>
                            </div>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Voice Settings</h3>

                        <div class="field">
                            <label for="ttsNativeVoiceName">Voice Name</label>
                            <select id="ttsNativeVoiceName" name="ttsNativeVoiceName">
                                <option value="">Default browser voice</option>
                            </select>
                        </div>

                        <div class="field">
                            <label for="ttsRate">Rate</label>
                            <div class="range-row">
                                <input id="ttsRate" name="ttsRate" type="range" min="0.5" max="2" step="0.1" value="1">
                                <output class="range-value" id="ttsRate-value" for="ttsRate">1.0</output>
                            </div>
                        </div>

                        <div class="field">
                            <label for="ttsPitch">Pitch</label>
                            <div class="range-row">
                                <input id="ttsPitch" name="ttsPitch" type="range" min="0" max="2" step="0.1" value="1">
                                <output class="range-value" id="ttsPitch-value" for="ttsPitch">1.0</output>
                            </div>
                        </div>

                        <div class="field">
                            <button type="button" class="btn-secondary" id="test-voice" aria-pressed="false">Play Voice Sample</button>
                            <div class="voice-status" id="voice-status" aria-live="polite"></div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="reset-defaults">Reset Defaults</button>
                    </div>
                </form>
            </section>

            <section class="panel" aria-labelledby="preview-heading">
                <div class="preview-panel-header">
                    <h2 id="preview-heading">Live Preview</h2>
                </div>
                <p class="preview-note">Use the floating widget inside this isolated preview to test behavior before exporting code.</p>
                <iframe id="widget-preview" class="preview-frame" title="AccessibleWeb Widget preview"
                    sandbox="allow-scripts allow-same-origin"></iframe>
            </section>
        </div>

        <section class="panel export-section" aria-labelledby="export-heading">
            <div class="export-header">
                <h2 id="export-heading">Export Code</h2>
                <button type="button" class="copy-btn" id="copy-export" aria-label="Copy code">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </button>
            </div>
            <p class="export-note">Paste this snippet into your site before <code>&lt;/body&gt;</code>.</p>
            <pre class="export-code"><code id="export-code"></code></pre>
            <div class="status" id="copy-status" aria-live="polite"></div>
        </section>

        <section class="panel export-section" aria-labelledby="self-host-heading">
            <div class="export-header">
                <h2 id="self-host-heading">Self Host</h2>
            </div>
            <p class="export-note">Download your customized widget file, upload it to your website, then add this script
                tag before <code>&lt;/body&gt;</code>.</p>
            <div class="form-actions self-host-download-actions">
                <button type="button" class="btn-secondary" id="download-custom-widget">Download customized widget</button>
            </div>
            <div class="implementation-code">
                <code id="self-host-script" tabindex="0">&lt;script src="./accessible-web-widget.custom.min.js"&gt;&lt;/script&gt;</code>
                <button type="button" class="copy-btn" id="copy-self-host" aria-label="Copy self host script">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </button>
            </div>
            <div class="status" id="self-host-status" aria-live="polite"></div>
        </section>
    </main>

    <footer class="footer">
        <div class="footer-left">AccessibleWeb Widget &middot; MIT License</div>
        <div class="footer-links">
            <a href="https://github.com/ifrederico/accessible-web-widget" target="_blank" rel="noopener">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path
                        d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" />
                </svg>
                <span>GitHub</span>
            </a>
            <a href="https://github.com/ifrederico/accessible-web-widget/blob/main/DISCLAIMER.md" target="_blank"
                rel="noopener">Disclaimer</a>
        </div>
    </footer>

    <script src="./nav-mobile.js"></script>

    <script>
        (function () {
            var defaults = {
                position: 'top-right',
                offsetX: 24,
                offsetY: 24,
                size: 52,
                accentColor: '#1976d2',
                icon: 'default',
                ttsNativeVoiceName: 'Samantha',
                ttsRate: 1.0,
                ttsPitch: 1.0
            };

            var samplePoem = "There was an Old Man with a beard, who said, \"It is just as I feared! Two owls and a hen, four larks and a wren, have all built their nests in my beard!\"";

            var layoutFieldNames = {
                position: true,
                offsetX: true,
                offsetY: true,
                size: true
            };

            var form = document.getElementById('config-form');
            var previewFrame = document.getElementById('widget-preview');
            var exportCode = document.getElementById('export-code');
            var copyButton = document.getElementById('copy-export');
            var copySelfHostButton = document.getElementById('copy-self-host');
            var selfHostScript = document.getElementById('self-host-script');
            var downloadCustomButton = document.getElementById('download-custom-widget');
            var copyStatus = document.getElementById('copy-status');
            var selfHostStatus = document.getElementById('self-host-status');
            var resetButton = document.getElementById('reset-defaults');
            var testVoiceButton = document.getElementById('test-voice');
            var voiceStatus = document.getElementById('voice-status');
            var localBundleUrl = new URL('../dist/accessible-web-widget.js', window.location.href).href;
            var localBundleMinUrl = new URL('../dist/accessible-web-widget.min.js', window.location.href).href;
            var customBundleSourceCache = '';
            var availableVoices = [];
            var isVoiceSamplePlaying = false;
            var activeVoiceUtterance = null;

            var rangeOutputs = {
                offsetX: document.getElementById('offsetX-value'),
                offsetY: document.getElementById('offsetY-value'),
                size: document.getElementById('size-value'),
                ttsRate: document.getElementById('ttsRate-value'),
                ttsPitch: document.getElementById('ttsPitch-value')
            };

            function setSelectOptions(select, options) {
                while (select.firstChild) {
                    select.removeChild(select.firstChild);
                }
                options.forEach(function (optionData) {
                    var option = document.createElement('option');
                    option.value = optionData.value;
                    option.textContent = optionData.label;
                    select.appendChild(option);
                });
            }

            function hasOptionValue(select, value) {
                return Array.prototype.some.call(select.options, function (option) {
                    return option.value === value;
                });
            }

            function sortVoices(a, b) {
                if (a.default && !b.default) return -1;
                if (!a.default && b.default) return 1;
                return String(a.name || '').localeCompare(String(b.name || ''));
            }

            function findVoiceByName(name) {
                if (!name) return null;
                return availableVoices.find(function (voice) {
                    return String(voice.name || '') === name;
                }) || null;
            }

            function updateVoiceButtonState() {
                testVoiceButton.textContent = isVoiceSamplePlaying ? 'Stop Voice Sample' : 'Play Voice Sample';
                testVoiceButton.setAttribute('aria-pressed', isVoiceSamplePlaying ? 'true' : 'false');
            }

            function stopVoiceSample(showMessage) {
                if (!window.speechSynthesis || typeof window.speechSynthesis.cancel !== 'function') return;
                activeVoiceUtterance = null;
                isVoiceSamplePlaying = false;
                window.speechSynthesis.cancel();
                updateVoiceButtonState();
                if (showMessage) {
                    voiceStatus.textContent = 'Voice test stopped.';
                }
            }

            function loadAvailableVoices(preserveSelection) {
                var keepSelection = preserveSelection !== false;
                var voiceNameSelect = form.elements.ttsNativeVoiceName;
                var previousName = keepSelection ? String(voiceNameSelect.value || defaults.ttsNativeVoiceName) : '';

                if (!window.speechSynthesis || typeof window.speechSynthesis.getVoices !== 'function') {
                    availableVoices = [];
                    setSelectOptions(voiceNameSelect, [{ value: '', label: 'Speech synthesis not supported' }]);
                    voiceNameSelect.disabled = true;
                    testVoiceButton.disabled = true;
                    isVoiceSamplePlaying = false;
                    activeVoiceUtterance = null;
                    updateVoiceButtonState();
                    voiceStatus.textContent = 'This browser does not expose speech synthesis voices.';
                    return;
                }

                var voices = window.speechSynthesis.getVoices().slice().sort(sortVoices);
                availableVoices = voices;

                var voiceOptions = [{ value: '', label: 'Default browser voice' }];
                voices.forEach(function (voice) {
                    var label = String(voice.name || 'Unnamed voice');
                    if (voice.lang) label += ' (' + voice.lang + ')';
                    if (voice.default) label += ' [default]';
                    voiceOptions.push({ value: String(voice.name || ''), label: label });
                });
                setSelectOptions(voiceNameSelect, voiceOptions);

                voiceNameSelect.disabled = false;
                testVoiceButton.disabled = false;
                updateVoiceButtonState();

                if (previousName && hasOptionValue(voiceNameSelect, previousName)) {
                    voiceNameSelect.value = previousName;
                } else if (hasOptionValue(voiceNameSelect, defaults.ttsNativeVoiceName)) {
                    voiceNameSelect.value = defaults.ttsNativeVoiceName;
                } else {
                    voiceNameSelect.value = '';
                }

                if (voices.length) {
                    voiceStatus.textContent = 'Found ' + voices.length + ' browser voice(s).';
                } else {
                    voiceStatus.textContent = 'No voices reported yet. Click the test button after interacting with the page.';
                }
            }

            function speakVoiceSample() {
                if (!window.speechSynthesis || typeof window.SpeechSynthesisUtterance !== 'function') {
                    voiceStatus.textContent = 'Speech synthesis is not available in this browser.';
                    return;
                }

                var config = getConfig();
                var utterance = new SpeechSynthesisUtterance(samplePoem);
                var selectedVoice = findVoiceByName(config.ttsNativeVoiceName);
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                    if (selectedVoice.lang) {
                        utterance.lang = selectedVoice.lang;
                    }
                }
                utterance.rate = config.ttsRate;
                utterance.pitch = config.ttsPitch;
                utterance.onstart = function () {
                    if (activeVoiceUtterance !== utterance) return;
                    voiceStatus.textContent = 'Reading a famous limerick...';
                };
                utterance.onend = function () {
                    if (activeVoiceUtterance !== utterance) return;
                    activeVoiceUtterance = null;
                    isVoiceSamplePlaying = false;
                    updateVoiceButtonState();
                    voiceStatus.textContent = 'Voice test finished.';
                };
                utterance.onerror = function () {
                    if (activeVoiceUtterance !== utterance) return;
                    activeVoiceUtterance = null;
                    isVoiceSamplePlaying = false;
                    updateVoiceButtonState();
                    voiceStatus.textContent = 'Could not play voice test.';
                };
                stopVoiceSample(false);
                activeVoiceUtterance = utterance;
                isVoiceSamplePlaying = true;
                updateVoiceButtonState();
                window.speechSynthesis.speak(utterance);
            }

            function toggleVoiceSample() {
                if (isVoiceSamplePlaying) {
                    stopVoiceSample(true);
                    return;
                }
                speakVoiceSample();
            }

            function clamp(number, min, max) {
                return Math.min(max, Math.max(min, number));
            }

            function toNumber(value, fallback) {
                var parsed = Number(value);
                return Number.isFinite(parsed) ? parsed : fallback;
            }

            function formatDecimal(value) {
                return Number(value).toFixed(1);
            }

            function quoteJs(value) {
                return JSON.stringify(String(value || ''));
            }

            function escapeHtmlAttr(value) {
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            }

            function normalizeHexColor(value, fallback) {
                var input = String(value || '').trim();
                if (/^#[0-9a-fA-F]{3}$/.test(input)) {
                    var r = input.charAt(1);
                    var g = input.charAt(2);
                    var b = input.charAt(3);
                    return ('#' + r + r + g + g + b + b).toLowerCase();
                }
                if (/^#[0-9a-fA-F]{6}$/.test(input)) {
                    return input.toLowerCase();
                }
                return String(fallback || defaults.accentColor).toLowerCase();
            }

            function hexToRgb(hex) {
                var normalized = normalizeHexColor(hex, defaults.accentColor);
                return {
                    r: parseInt(normalized.slice(1, 3), 16),
                    g: parseInt(normalized.slice(3, 5), 16),
                    b: parseInt(normalized.slice(5, 7), 16)
                };
            }

            function rgbToHex(rgb) {
                var r = Math.min(255, Math.max(0, Math.round(rgb.r)));
                var g = Math.min(255, Math.max(0, Math.round(rgb.g)));
                var b = Math.min(255, Math.max(0, Math.round(rgb.b)));
                return '#' + [r, g, b].map(function (channel) {
                    return channel.toString(16).padStart(2, '0');
                }).join('');
            }

            function mixHexColor(baseHex, targetRgb, weight) {
                var base = hexToRgb(baseHex);
                var clampedWeight = Math.min(1, Math.max(0, Number(weight)));
                return rgbToHex({
                    r: base.r + (targetRgb.r - base.r) * clampedWeight,
                    g: base.g + (targetRgb.g - base.g) * clampedWeight,
                    b: base.b + (targetRgb.b - base.b) * clampedWeight
                });
            }

            function deriveAccentColors(accentHex) {
                var base = normalizeHexColor(accentHex, defaults.accentColor);
                return {
                    base: base,
                    light: mixHexColor(base, { r: 255, g: 255, b: 255 }, 0.22),
                    dark: mixHexColor(base, { r: 0, g: 0, b: 0 }, 0.28)
                };
            }

            function buildThemeOptions(accentHex) {
                var colors = deriveAccentColors(accentHex);
                return {
                    primaryColor: colors.base,
                    primaryColorLight: colors.light,
                    primaryColorDark: colors.dark,
                    focusRingColor: colors.base,
                    hoverColor: colors.light,
                    activeColor: colors.dark
                };
            }

            function getConfig() {
                var position = String(form.elements.position.value || defaults.position);
                var icon = String((form.elements.icon && form.elements.icon.value) || defaults.icon);
                var offsetX = Math.round(clamp(toNumber(form.elements.offsetX.value, defaults.offsetX), 0, 120));
                var offsetY = Math.round(clamp(toNumber(form.elements.offsetY.value, defaults.offsetY), 0, 120));
                var size = Math.round(clamp(toNumber(form.elements.size.value, defaults.size), 24, 96));
                var accentColor = normalizeHexColor(form.elements.accentColor.value, defaults.accentColor);
                var voiceName = String(form.elements.ttsNativeVoiceName.value || '').trim();
                var rate = clamp(toNumber(form.elements.ttsRate.value, defaults.ttsRate), 0.5, 2);
                var pitch = clamp(toNumber(form.elements.ttsPitch.value, defaults.ttsPitch), 0, 2);

                return {
                    position: position,
                    icon: icon,
                    offsetX: offsetX,
                    offsetY: offsetY,
                    size: size,
                    accentColor: accentColor,
                    ttsNativeVoiceName: voiceName,
                    ttsRate: Number(formatDecimal(rate)),
                    ttsPitch: Number(formatDecimal(pitch))
                };
            }

            function updateRangeValues(config) {
                rangeOutputs.offsetX.textContent = config.offsetX + 'px';
                rangeOutputs.offsetY.textContent = config.offsetY + 'px';
                rangeOutputs.size.textContent = config.size + 'px';
                rangeOutputs.ttsRate.textContent = formatDecimal(config.ttsRate);
                rangeOutputs.ttsPitch.textContent = formatDecimal(config.ttsPitch);
            }

            function buildExportSnippet(config) {
                var themeOptions = buildThemeOptions(config.accentColor);
                return [
                    '<!-- AccessibleWeb Widget -->',
                    '<div data-acc-position="' + escapeHtmlAttr(config.position) + '"></div>',
                    '<div data-acc-offset="' + config.offsetX + ',' + config.offsetY + '"></div>',
                    '<div data-acc-size="' + config.size + '"></div>',
                    '<div data-acc-icon="' + escapeHtmlAttr(config.icon) + '"></div>',
                    '<script>',
                    '  window.AccessibleWebWidgetOptions = {',
                    '    primaryColor: ' + quoteJs(themeOptions.primaryColor) + ',',
                    '    ttsNativeVoiceName: ' + quoteJs(config.ttsNativeVoiceName) + ',',
                    '    ttsRate: ' + formatDecimal(config.ttsRate) + ',',
                    '    ttsPitch: ' + formatDecimal(config.ttsPitch) + ',',
                    '    ...(window.AccessibleWebWidgetOptions || {})',
                    '  };',
                    '<\/script>',
                    '<script src="https://cdn.jsdelivr.net/gh/ifrederico/accessible-web-widget@latest/dist/accessible-web-widget.min.js"><\/script>'
                ].join('\n');
            }

            function buildCustomBundleBootstrap(config) {
                var themeOptions = buildThemeOptions(config.accentColor);
                return [
                    '(function () {',
                    '  var optionDefaults = {',
                    '    primaryColor: ' + quoteJs(themeOptions.primaryColor) + ',',
                    '    ttsNativeVoiceName: ' + quoteJs(config.ttsNativeVoiceName) + ',',
                    '    ttsRate: ' + formatDecimal(config.ttsRate) + ',',
                    '    ttsPitch: ' + formatDecimal(config.ttsPitch),
                    '  };',
                    '  window.AccessibleWebWidgetOptions = Object.assign({}, optionDefaults, window.AccessibleWebWidgetOptions || {});',
                    '',
                    '  function ensureDataOption(name, value) {',
                    '    var node = document.querySelector("div[" + name + "]");',
                    '    if (!node) {',
                    '      node = document.createElement("div");',
                    '      (document.body || document.documentElement).appendChild(node);',
                    '    }',
                    '    node.setAttribute(name, value);',
                    '  }',
                    '',
                    '  ensureDataOption("data-acc-position", ' + quoteJs(config.position) + ');',
                    '  ensureDataOption("data-acc-offset", ' + quoteJs(config.offsetX + ',' + config.offsetY) + ');',
                    '  ensureDataOption("data-acc-size", ' + quoteJs(String(config.size)) + ');',
                    '  ensureDataOption("data-acc-icon", ' + quoteJs(config.icon) + ');',
                    '})();'
                ].join('\n');
            }

            function getCustomBundleSource() {
                if (customBundleSourceCache) {
                    return Promise.resolve(customBundleSourceCache);
                }
                return fetch(localBundleMinUrl).then(function (response) {
                    if (!response.ok) {
                        throw new Error('Bundle request failed');
                    }
                    return response.text();
                }).then(function (source) {
                    customBundleSourceCache = source;
                    return source;
                });
            }

            function downloadTextFile(filename, content) {
                var blob = new Blob([content], { type: 'application/javascript' });
                var blobUrl = URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.href = blobUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setTimeout(function () {
                    URL.revokeObjectURL(blobUrl);
                }, 0);
            }

            function setSelfHostStatus(message) {
                if (selfHostStatus) {
                    selfHostStatus.textContent = message;
                    return;
                }
                copyStatus.textContent = message;
            }

            function buildPreviewDocument(config) {
                var themeOptions = buildThemeOptions(config.accentColor);
                return '<!DOCTYPE html>\n' +
                    '<html lang="en">\n' +
                    '<head>\n' +
                    '  <meta charset="UTF-8">\n' +
                    '  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
                    '  <title>AccessibleWeb Preview</title>\n' +
                    '  <style>\n' +
                    '    :root { color-scheme: light; }\n' +
                    '    body { margin: 0; background: var(--acc-card-bg, #ffffff); }\n' +
                    '    .preview-wrap { padding: 26px; }\n' +
                    '    .sk { border-radius: 10px; background: #d9dde3; }\n' +
                    '    .sk-row { display: flex; gap: 12px; align-items: center; margin-bottom: 20px; }\n' +
                    '    .sk-logo { width: 130px; height: 20px; border-radius: 999px; }\n' +
                    '    .sk-chip { width: 72px; height: 16px; border-radius: 999px; }\n' +
                    '    .sk-chip.wide { width: 118px; }\n' +
                    '    .sk-hero-title { width: 72%; max-width: 540px; height: 36px; margin-bottom: 14px; }\n' +
                    '    .sk-hero-line { height: 14px; margin-bottom: 10px; }\n' +
                    '    .sk-hero-line.short { width: 76%; }\n' +
                    '    .sk-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px; margin-top: 18px; }\n' +
                    '    .sk-card { border-radius: 12px; padding: 14px; background: #eef2f7; }\n' +
                    '    .sk-card-title { width: 45%; height: 16px; margin-bottom: 12px; }\n' +
                    '    .sk-card-line { height: 11px; margin-bottom: 8px; }\n' +
                    '    .sk-card-line:last-child { margin-bottom: 0; width: 82%; }\n' +
                    '    .sk-band { height: 42px; border-radius: 12px; margin-top: 16px; }\n' +
                    '    .sk-band.thin { height: 24px; margin-top: 12px; width: 64%; }\n' +
                    '    @media (max-width: 700px) { .preview-wrap { padding: 18px; } .sk-grid { grid-template-columns: 1fr; } .sk-hero-title { width: 92%; } }\n' +
                    '  </style>\n' +
                    '</head>\n' +
                    '<body>\n' +
                    '  <main class="preview-wrap">\n' +
                    '    <div class="sk-row">\n' +
                    '      <div class="sk sk-logo"></div>\n' +
                    '      <div class="sk sk-chip"></div>\n' +
                    '      <div class="sk sk-chip"></div>\n' +
                    '      <div class="sk sk-chip wide"></div>\n' +
                    '    </div>\n' +
                    '    <div class="sk sk-hero-title"></div>\n' +
                    '    <div class="sk sk-hero-line"></div>\n' +
                    '    <div class="sk sk-hero-line short"></div>\n' +
                    '    <div class="sk-grid">\n' +
                    '      <article class="sk-card">\n' +
                    '        <div class="sk sk-card-title"></div>\n' +
                    '        <div class="sk sk-card-line"></div>\n' +
                    '        <div class="sk sk-card-line"></div>\n' +
                    '        <div class="sk sk-card-line"></div>\n' +
                    '      </article>\n' +
                    '      <article class="sk-card">\n' +
                    '        <div class="sk sk-card-title"></div>\n' +
                    '        <div class="sk sk-card-line"></div>\n' +
                    '        <div class="sk sk-card-line"></div>\n' +
                    '        <div class="sk sk-card-line"></div>\n' +
                    '      </article>\n' +
                    '    </div>\n' +
                    '    <div class="sk sk-band"></div>\n' +
                    '    <div class="sk sk-band thin"></div>\n' +
                    '  </main>\n' +
                    '  <div data-acc-position="' + escapeHtmlAttr(config.position) + '"></div>\n' +
                    '  <div data-acc-offset="' + config.offsetX + ',' + config.offsetY + '"></div>\n' +
                    '  <div data-acc-size="' + config.size + '"></div>\n' +
                    '  <div data-acc-icon="' + escapeHtmlAttr(config.icon) + '"></div>\n' +
                    '  <script>\n' +
                    '    window.AccessibleWebWidgetOptions = {\n' +
                    '      primaryColor: ' + quoteJs(themeOptions.primaryColor) + ',\n' +
                    '      primaryColorLight: ' + quoteJs(themeOptions.primaryColorLight) + ',\n' +
                    '      primaryColorDark: ' + quoteJs(themeOptions.primaryColorDark) + ',\n' +
                    '      focusRingColor: ' + quoteJs(themeOptions.focusRingColor) + ',\n' +
                    '      hoverColor: ' + quoteJs(themeOptions.hoverColor) + ',\n' +
                    '      activeColor: ' + quoteJs(themeOptions.activeColor) + ',\n' +
                    '      ttsNativeVoiceName: ' + quoteJs(config.ttsNativeVoiceName) + ',\n' +
                    '      ttsRate: ' + formatDecimal(config.ttsRate) + ',\n' +
                    '      ttsPitch: ' + formatDecimal(config.ttsPitch) + ',\n' +
                    '      ...(window.AccessibleWebWidgetOptions || {})\n' +
                    '    };\n' +
                    '  <\/script>\n' +
                    '  <script src="' + escapeHtmlAttr(localBundleUrl) + '"><\/script>\n' +
                    '</body>\n' +
                    '</html>';
            }

            function applyLayoutToPreview(config) {
                var frameWindow = previewFrame.contentWindow;
                if (!frameWindow || !frameWindow.document) return false;
                var btn = frameWindow.document.querySelector('.acc-widget .acc-toggle-btn');
                if (!btn) return false;

                btn.style.left = 'auto';
                btn.style.right = 'auto';
                btn.style.top = 'auto';
                btn.style.bottom = 'auto';
                btn.style.transform = '';

                if (config.position === 'bottom-right') {
                    btn.style.right = config.offsetX + 'px';
                    btn.style.bottom = config.offsetY + 'px';
                } else if (config.position === 'top-left') {
                    btn.style.left = config.offsetX + 'px';
                    btn.style.top = config.offsetY + 'px';
                } else if (config.position === 'top-right') {
                    btn.style.right = config.offsetX + 'px';
                    btn.style.top = config.offsetY + 'px';
                } else {
                    btn.style.left = config.offsetX + 'px';
                    btn.style.bottom = config.offsetY + 'px';
                }

                btn.style.setProperty('--acc-button-size', config.size + 'px');

                var menu = frameWindow.document.querySelector('.acc-menu');
                if (menu) {
                    var isRightAligned = config.position === 'bottom-right' || config.position === 'top-right';
                    menu.style.right = isRightAligned ? 'var(--acc-menu-inline-gap, 12px)' : 'auto';
                    menu.style.left = isRightAligned ? 'auto' : 'var(--acc-menu-inline-gap, 12px)';

                    var menuOffset = config.offsetY + config.size + 16;
                    menu.style.top = 'auto';
                    menu.style.bottom = 'auto';

                    if (config.position === 'bottom-right' || config.position === 'bottom-left') {
                        menu.style.bottom = 'calc(' + menuOffset + 'px)';
                    } else {
                        menu.style.top = 'calc(' + menuOffset + 'px)';
                    }
                }
                return true;
            }

            function applyColorToPreview(config) {
                var frameWindow = previewFrame.contentWindow;
                if (!frameWindow || !frameWindow.document || !frameWindow.document.documentElement) return false;
                var themeOptions = buildThemeOptions(config.accentColor);
                var root = frameWindow.document.documentElement;
                root.style.setProperty('--acc-primary-color', themeOptions.primaryColor);
                root.style.setProperty('--acc-primary-color-light', themeOptions.primaryColorLight);
                root.style.setProperty('--acc-primary-color-dark', themeOptions.primaryColorDark);
                root.style.setProperty('--acc-focus-ring-color', themeOptions.focusRingColor);
                root.style.setProperty('--acc-hover-color', themeOptions.hoverColor);
                root.style.setProperty('--acc-active-color', themeOptions.activeColor);
                return true;
            }

            function applyPreviewFromConfig(config) {
                previewFrame.srcdoc = buildPreviewDocument(config);
            }

            function refreshExport() {
                var config = getConfig();
                updateRangeValues(config);
                exportCode.textContent = buildExportSnippet(config);
            }

            function applyPreview() {
                var config = getConfig();
                updateRangeValues(config);
                exportCode.textContent = buildExportSnippet(config);
                applyPreviewFromConfig(config);
                copyStatus.textContent = '';
                setSelfHostStatus('');
            }

            function handleControlUpdate(fieldName, eventType) {
                var config = getConfig();
                updateRangeValues(config);
                exportCode.textContent = buildExportSnippet(config);
                copyStatus.textContent = '';
                setSelfHostStatus('');

                if (layoutFieldNames[fieldName]) {
                    var shouldRebuildLayout = fieldName === 'position' || eventType === 'change';
                    if (shouldRebuildLayout) {
                        applyPreviewFromConfig(config);
                        return;
                    }
                    if (!applyLayoutToPreview(config)) {
                        applyPreviewFromConfig(config);
                    }
                    return;
                }

                if (fieldName === 'accentColor') {
                    applyPreviewFromConfig(config);
                    return;
                }

                applyPreviewFromConfig(config);
            }

            function setFormValues(config) {
                form.elements.position.value = config.position;
                var iconValue = config.icon || defaults.icon;
                Array.prototype.forEach.call(form.querySelectorAll('input[name="icon"]'), function (input) {
                    input.checked = input.value === iconValue;
                });
                form.elements.offsetX.value = String(config.offsetX);
                form.elements.offsetY.value = String(config.offsetY);
                form.elements.size.value = String(config.size);
                form.elements.accentColor.value = normalizeHexColor(config.accentColor, defaults.accentColor);
                if (hasOptionValue(form.elements.ttsNativeVoiceName, config.ttsNativeVoiceName)) {
                    form.elements.ttsNativeVoiceName.value = config.ttsNativeVoiceName;
                } else {
                    form.elements.ttsNativeVoiceName.value = '';
                }
                form.elements.ttsRate.value = formatDecimal(config.ttsRate);
                form.elements.ttsPitch.value = formatDecimal(config.ttsPitch);
            }

            if (window.speechSynthesis && typeof window.speechSynthesis.addEventListener === 'function') {
                window.speechSynthesis.addEventListener('voiceschanged', function () {
                    loadAvailableVoices(true);
                    refreshExport();
                });
            } else if (window.speechSynthesis) {
                window.speechSynthesis.onvoiceschanged = function () {
                    loadAvailableVoices(true);
                    refreshExport();
                };
            }

            testVoiceButton.addEventListener('click', function () {
                toggleVoiceSample();
            });

            form.addEventListener('input', function (event) {
                var fieldName = event.target && event.target.name ? event.target.name : '';
                handleControlUpdate(fieldName, 'input');
            });

            form.addEventListener('change', function (event) {
                var fieldName = event.target && event.target.name ? event.target.name : '';
                handleControlUpdate(fieldName, 'change');
            });

            resetButton.addEventListener('click', function () {
                setFormValues(defaults);
                applyPreview();
            });

            copyButton.addEventListener('click', function () {
                var text = exportCode.textContent;
                var icon = copyButton.querySelector('svg');
                if (!navigator.clipboard || !navigator.clipboard.writeText) {
                    copyStatus.textContent = 'Clipboard unavailable in this browser.';
                    return;
                }
                navigator.clipboard.writeText(text).then(function () {
                    copyStatus.textContent = 'Code copied.';
                    if (icon) {
                        var original = icon.innerHTML;
                        icon.innerHTML = '<polyline points="20 6 9 17 4 12" />';
                        copyButton.style.color = '#22c55e';
                        setTimeout(function () {
                            icon.innerHTML = original;
                            copyButton.style.color = '';
                        }, 1200);
                    }
                }).catch(function () {
                    copyStatus.textContent = 'Could not copy. Select and copy manually.';
                });
            });

            if (copySelfHostButton && selfHostScript) {
                copySelfHostButton.addEventListener('click', function () {
                    var text = selfHostScript.textContent;
                    var icon = copySelfHostButton.querySelector('svg');
                    if (!navigator.clipboard || !navigator.clipboard.writeText) {
                        setSelfHostStatus('Clipboard unavailable in this browser.');
                        return;
                    }
                    navigator.clipboard.writeText(text).then(function () {
                        setSelfHostStatus('Script copied.');
                        if (icon) {
                            var original = icon.innerHTML;
                            icon.innerHTML = '<polyline points="20 6 9 17 4 12" />';
                            copySelfHostButton.style.color = '#22c55e';
                            setTimeout(function () {
                                icon.innerHTML = original;
                                copySelfHostButton.style.color = '';
                            }, 1200);
                        }
                    }).catch(function () {
                        setSelfHostStatus('Could not copy. Select and copy manually.');
                    });
                });
            }

            if (downloadCustomButton) {
                downloadCustomButton.addEventListener('click', function () {
                    var config = getConfig();
                    downloadCustomButton.disabled = true;
                    setSelfHostStatus('Preparing customized widget download...');
                    getCustomBundleSource().then(function (bundleSource) {
                        var bundle = buildCustomBundleBootstrap(config) + '\n\n' + bundleSource;
                        downloadTextFile('accessible-web-widget.custom.min.js', bundle);
                        setSelfHostStatus('Customized widget downloaded.');
                        downloadCustomButton.disabled = false;
                    }).catch(function () {
                        setSelfHostStatus('Could not prepare download. Try again.');
                        downloadCustomButton.disabled = false;
                    });
                });
            }

            loadAvailableVoices(false);
            updateVoiceButtonState();
            setFormValues(defaults);
            applyPreview();
        })();
    </script>
</body>

</html>
